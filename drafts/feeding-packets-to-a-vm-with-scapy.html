<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Feeding packets to a VM with Scapy</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Jakub Sitnicki's blog </a></h1>
                <nav><ul>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/drafts/feeding-packets-to-a-vm-with-scapy.html" rel="bookmark"
           title="Permalink to Feeding packets to a VM with Scapy">Feeding packets to a VM with Scapy</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-10-22T00:00:00+02:00">
                Published: Sat 22 October 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/jakub-sitnicki.html">Jakub Sitnicki <jkbs@redhat.com></a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>

</footer><!-- /.post-info -->      <p>Want to send hand crafted packets to a VM? <a class="reference external" href="http://www.secdev.org/projects/scapy/doc/">Scapy</a> can be used for
that. It can sniff on a <a class="reference external" href="https://en.wikipedia.org/wiki/TUN/TAP">TAP</a> device, a virtual link between the host
and the VM, and send packets in reaction to what it sees coming from
the VM.</p>
<p>In this case, I needed to simulate a quirky switch which is notorious
for tagging every packet forwarded to the host with VLAN ID 0.</p>
<p>This was confusing the network stack in the VM and a simple ping test
from the VM to the outside was failing.</p>
<p>To reproduce this scenario, I've extended a bit the <a class="reference external" href="http://www.secdev.org/projects/scapy/doc/usage.html#simplistic-arp-monitor">Simplistic ARP
Monitor</a> example from Scapy's excellent documentation.</p>
<p>What we want to do is:</p>
<ol class="arabic simple">
<li>for every ARP request from the VM, send a VLAN 0 tagged ARP reply,</li>
<li>for every ICMP Echo request from the VM, send a VLAN 0 tagged ICMP
Echo reply,</li>
<li>ignore everything else.</li>
</ol>
<p>My Scapy script to do just that is <a class="reference external" href="https://github.com/jsitnicki/tools/blob/master/net/scapy/arp_and_icmp_reply_with_vlan0.py">here</a>. Now all that is left is to
attach the script to a TAP device linking to the VM.</p>
<p>I like to use Andrew Lutomirski's <a class="reference external" href="https://github.com/amluto/virtme">virtme</a> tool to spin up toy VMs
but it's doesn't matter what you use - qemu, virsh,
virt-manager... What is important is the vNIC model you choose. For
example, I had problems with virtio_net v1.0.0 driver
(qemu-system-x86-2.6.2-2.fc24.x86_64), which seems to be filtering
VLAN 0 tagged frames when the device is not in promiscuous mode. A
bug?</p>
<p>Let's start up a VM:</p>
<pre class="literal-block">
$ sudo virtme-run \
    --installed-kernel \
    --qemu-opts -net nic,model=e1000 -net tap,script=no,downscript=no
[    0.000000] Linux version 4.7.7-200.fc24.x86_64 (mockbuild&#64;bkernel01.phx2.fedoraproject.org) (gcc version 6.2.1 20160916 (Red Hat 6.2.1-2) (GCC) ) #1 SMP Sat Oct 8 00:21:59 UTC 2016
…
virtme-init: console is ttyS0
bash-4.3# ip link show
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: ens2: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 52:54:00:12:34:56 brd ff:ff:ff:ff:ff:ff
bash-4.3# ethtool -i ens2
driver: e1000
version: 7.3.21-k8-NAPI
…
</pre>
<p>The <tt class="docutils literal">e1000</tt> virtual network device is there. Let's assign it an
address and bring it up:</p>
<pre class="literal-block">
bash-4.3# ip address add dev ens2 10.1.1.1/24
bash-4.3# ip link set dev ens2 up
</pre>
<p>While on the host a TAP device has showed up (you might find it under
another name, like <tt class="docutils literal">vnetX</tt>). Let's bring it up. We don't need to do
anything else with it for this test, like enslave it to a bridge.</p>
<pre class="literal-block">
$ ip link show
...
12: tap0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 6a:fb:0b:61:63:94 brd ff:ff:ff:ff:ff:ff
$ sudo ip link set dev tap0 up
</pre>
<p>We are ready to carry out the test. Let's put Scapy to work:</p>
<pre class="literal-block">
$ sudo ~/tools/net/scapy/arp_and_icmp_reply_with_vlan0.py tap0
WARNING: No route found for IPv6 destination :: (no default route?)
</pre>
<p>It will be useful to monitor the traffic exchanged with the VM to
confirm that what is happening is what we expect. On another terminal
run <tt class="docutils literal">tcpdump <span class="pre">-n</span> <span class="pre">-nn</span> <span class="pre">-ei</span> tap0 <span class="pre">-t</span></tt>.</p>
<p>Now let's ping from the VM a fake address on the same subnet as VM
thinks its on:</p>
<pre class="literal-block">
bash-4.3# ping -c 3 10.1.1.2
PING 10.1.1.2 (10.1.1.2) 56(84) bytes of data.
64 bytes from 10.1.1.2: icmp_seq=1 ttl=64 time=20.3 ms
64 bytes from 10.1.1.2: icmp_seq=2 ttl=64 time=8.60 ms
64 bytes from 10.1.1.2: icmp_seq=3 ttl=64 time=7.30 ms

--- 10.1.1.2 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 7.305/12.100/20.394/5.889 ms
</pre>
<p>Scapy script is reporting what it has sniffed on the TAP interface and
that replies were sent.</p>
<pre class="literal-block">
.
Sent 1 packets.
Ether / ARP who has 10.1.1.2 says 10.1.1.1 / Padding
Ether / Dot1Q / ARP is at 0a:e0:c5:28:0c:a7 says 10.1.1.2
.
Sent 1 packets.
Ether / IP / ICMP 10.1.1.1 &gt; 10.1.1.2 echo-request 0 / Raw
Ether / Dot1Q / IP / ICMP 10.1.1.2 &gt; 10.1.1.1 echo-reply 0 / Raw
.
Sent 1 packets.
Ether / IP / ICMP 10.1.1.1 &gt; 10.1.1.2 echo-request 0 / Raw
Ether / Dot1Q / IP / ICMP 10.1.1.2 &gt; 10.1.1.1 echo-reply 0 / Raw
.
Sent 1 packets.
Ether / IP / ICMP 10.1.1.1 &gt; 10.1.1.2 echo-request 0 / Raw
Ether / Dot1Q / IP / ICMP 10.1.1.2 &gt; 10.1.1.1 echo-reply 0 / Raw
</pre>
<p>And the traffic capture confirms it:</p>
<pre class="literal-block">
52:54:00:12:34:56 &gt; ff:ff:ff:ff:ff:ff, ethertype ARP (0x0806), length 60: Request who-has 10.1.1.2 tell 10.1.1.1, length 46
0a:e0:c5:28:0c:a7 &gt; 52:54:00:12:34:56, ethertype 802.1Q (0x8100), length 46: vlan 0, p 0, ethertype ARP, Reply 10.1.1.2 is-at 0a:e0:c5:28:0c:a7, length 28
52:54:00:12:34:56 &gt; 0a:e0:c5:28:0c:a7, ethertype IPv4 (0x0800), length 98: 10.1.1.1 &gt; 10.1.1.2: ICMP echo request, id 246, seq 1, length 64
0a:e0:c5:28:0c:a7 &gt; 52:54:00:12:34:56, ethertype 802.1Q (0x8100), length 102: vlan 0, p 0, ethertype IPv4, 10.1.1.2 &gt; 10.1.1.1: ICMP echo reply, id 246, seq 1, length 64
52:54:00:12:34:56 &gt; 0a:e0:c5:28:0c:a7, ethertype IPv4 (0x0800), length 98: 10.1.1.1 &gt; 10.1.1.2: ICMP echo request, id 246, seq 2, length 64
0a:e0:c5:28:0c:a7 &gt; 52:54:00:12:34:56, ethertype 802.1Q (0x8100), length 102: vlan 0, p 0, ethertype IPv4, 10.1.1.2 &gt; 10.1.1.1: ICMP echo reply, id 246, seq 2, length 64
52:54:00:12:34:56 &gt; 0a:e0:c5:28:0c:a7, ethertype IPv4 (0x0800), length 98: 10.1.1.1 &gt; 10.1.1.2: ICMP echo request, id 246, seq 3, length 64
0a:e0:c5:28:0c:a7 &gt; 52:54:00:12:34:56, ethertype 802.1Q (0x8100), length 102: vlan 0, p 0, ethertype IPv4, 10.1.1.2 &gt; 10.1.1.1: ICMP echo reply, id 246, seq 3, length 64
</pre>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>